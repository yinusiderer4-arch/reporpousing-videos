<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Transcriber Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">

    <div class="container mx-auto max-w-5xl px-4 py-12">
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-4">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500">
                    AI Content Factory
                </span>
            </h1>
            <p class="text-gray-400 text-lg">De Video a Viral: Transcripción, Twitter, LinkedIn y TikTok en 1 clic.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl hover:border-purple-500 transition">
                <div class="flex items-center mb-4">
                    <i class="fab fa-youtube text-red-500 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold">Pegar Enlace YouTube</h2>
                </div>
                <input type="text" id="videoUrl" placeholder="https://youtube.com/watch?v=..." 
                       class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none mb-4 text-white">
                <button onclick="procesarYoutube()" id="btnYoutube"
                        class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 py-3 rounded-lg font-bold transition duration-200 shadow-lg">
                    <i class="fas fa-magic mr-2"></i> Generar Pack Viral
                </button>
            </div>

            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl hover:border-blue-500 transition">
                <div class="flex items-center mb-4">
                    <i class="fas fa-cloud-upload-alt text-blue-400 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold">Subir Archivo (Audio/Video)</h2>
                </div>
                <div id="dropZone" class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-blue-500 transition cursor-pointer mb-4 bg-gray-900/50">
                    <input type="file" id="fileInput" class="hidden" accept="audio/*,video/*">
                    <i class="fas fa-file-audio text-3xl text-gray-500 mb-2"></i>
                    <p id="fileName" class="text-gray-400 text-sm">Arrastra o haz clic aquí (.mp3, .m4a)</p>
                </div>
                <button onclick="procesarArchivo()" id="btnFile"
                        class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-bold transition duration-200">
                    Transcribir y generar
                </button>
            </div>
        </div>

        <div id="loader" class="hidden mt-12 text-center">
            <div class="relative inline-flex">
                <div class="w-16 h-16 bg-purple-500 rounded-full animate-ping opacity-75"></div>
                <div class="absolute top-0 left-0 w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white text-2xl animate-bounce"></i>
                </div>
            </div>
            <p class="mt-6 text-xl text-gray-300 font-medium">Analizando contenido y redactando posts...</p>
            <p class="text-sm text-gray-500 mt-2">Esto puede tardar un rato en función del video/audio.</p>
        </div>

        <div id="resultArea" class="hidden space-y-8 animate-fade-in-up">
            
            <div id="viralSection" class="hidden">
                <div class="flex items-center mb-6">
                    <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">
                        <i class="fas fa-fire mr-2"></i> Pack Viral Generado
                    </h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="bg-gray-800 rounded-xl p-6 border border-yellow-500/30 shadow-lg col-span-1 md:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-yellow-400 font-bold"><i class="fas fa-lightbulb mr-2"></i> Resumen Ejecutivo</h4>
                            <button onclick="copyToClipboard('resumenContent')" class="text-gray-400 hover:text-white text-sm"><i class="far fa-copy"></i></button>
                        </div>
                        <p id="resumenContent" class="text-lg text-gray-200 leading-relaxed"></p>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 border border-blue-500/30 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-blue-400 font-bold"><i class="fab fa-twitter mr-2"></i> Hilo de Twitter</h4>
                            <button onclick="copyToClipboard('twitterContent')" class="text-gray-400 hover:text-white text-sm"><i class="far fa-copy"></i> Copiar Hilo</button>
                        </div>
                        <div id="twitterContent" class="space-y-4 text-sm text-gray-300"></div>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 border border-blue-700/30 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-blue-600 font-bold"><i class="fab fa-linkedin mr-2"></i> Post LinkedIn</h4>
                            <button onclick="copyToClipboard('linkedinContent')" class="text-gray-400 hover:text-white text-sm"><i class="far fa-copy"></i></button>
                        </div>
                        <div id="linkedinContent" class="whitespace-pre-wrap text-sm text-gray-300 leading-relaxed"></div>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 border border-pink-500/30 shadow-lg col-span-1 md:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-pink-500 font-bold"><i class="fab fa-tiktok mr-2"></i> Guion TikTok / Reels</h4>
                            <button onclick="copyToClipboard('tiktokContent')" class="text-gray-400 hover:text-white text-sm"><i class="far fa-copy"></i></button>
                        </div>
                        <div id="tiktokContent" class="whitespace-pre-wrap text-sm text-gray-300 font-mono bg-gray-900 p-4 rounded-lg border border-gray-700"></div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-2xl border border-gray-700 p-8 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-400"><i class="fas fa-align-left mr-2"></i> Transcripción Completa</h3>
                    <button onclick="copyToClipboard('transcripcion')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm transition">
                        <i class="far fa-copy mr-2"></i> Copiar Texto
                    </button>
                </div>
                <div id="transcripcion" class="bg-gray-900 p-6 rounded-xl border border-gray-700 text-gray-400 text-sm leading-relaxed max-h-64 overflow-y-auto whitespace-pre-wrap font-mono">
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- LOGICA FRONTEND ---

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisp = document.getElementById('fileName');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            if(e.target.files.length > 0) fileNameDisp.innerText = "Archivo: " + e.target.files[0].name;
        };

        async function apiCall(endpoint, body) {
            showUI(true);
            hideResults();
            
            try {
                // Determine if it's form data (file) or JSON/URLencoded (youtube)
                const isFormData = body instanceof FormData;
                const headers = isFormData ? {} : { 'Content-Type': 'application/x-www-form-urlencoded' };
                
                const response = await fetch(endpoint, { 
                    method: 'POST', 
                    headers: headers,
                    body: body 
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                renderResults(data);

            } catch (e) {
                alert("❌ Ocurrió un error: " + e.message);
                console.error(e);
            } finally {
                showUI(false);
            }
        }

        function renderResults(data) {
            // 1. DETECTOR DE ERRORES DE API (Groq)
            const texto = data.transcripcion || data.transcripcion_completa || "";
            
            // Si el texto contiene el código de error de límite
            if (texto.includes("Error code: 429") || texto.includes("Rate limit reached")) {
                alert("⏳ LÍMITE DE VELOCIDAD ALCANZADO\n\nGroq (el motor gratuito) dice que has procesado demasiado audio en la última hora.\n\nEspera unos 20-30 minutos antes de intentarlo de nuevo.");
                
                // Opcional: Mostrarlo en el cuadro pero bonito
                document.getElementById('transcripcion').innerHTML = `<span class="text-red-400 font-bold">⚠️ El servicio está saturado temporalmente (Límite de API gratuito). Por favor, espera unos minutos.</span>`;
                document.getElementById('resultArea').classList.remove('hidden');
                return; // Cortamos aquí para no intentar pintar el resto
            }
            
            // Si es otro tipo de error técnico
            if (texto.startsWith("Error en Groq") || texto.startsWith("Error")) {
                alert("❌ Ocurrió un error técnico: " + texto);
                return;
            }

            // 2. Si todo va bien, mostramos la transcripción
            document.getElementById('transcripcion').innerText = texto || "Sin texto.";

            // 3. Logica visual para el Pack Viral
            if (data.pack_viral) {
                const pack = data.pack_viral;
                
                // --- RESUMEN ---
                document.getElementById('resumenContent').innerText = pack.resumen || "No disponible";
                
                // --- TWITTER ---
                const tweets = Array.isArray(pack.hilo_twitter) ? pack.hilo_twitter : [];
                const tweetsHtml = tweets.map((t, i) => 
                    `<div class="bg-gray-700/50 p-4 rounded-lg mb-3 border-l-4 border-blue-400 relative hover:bg-gray-700 transition">
                        <span class="absolute top-2 right-2 text-xs text-blue-400 font-bold opacity-50">${i+1}/${tweets.length}</span>
                        <p class="text-gray-200 text-base">${t}</p>
                     </div>`
                ).join('');
                document.getElementById('twitterContent').innerHTML = tweetsHtml || "<p class='text-gray-400'>No se generaron tweets.</p>";
                
                // --- LINKEDIN ---
                let linkedinRaw = pack.linkedin;
                let linkedinText = "No disponible";
                if (linkedinRaw) {
                    if (Array.isArray(linkedinRaw)) {
                        linkedinText = linkedinRaw.join('\n\n');
                    } else {
                        linkedinText = String(linkedinRaw);
                    }
                }
                linkedinText = linkedinText.replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>');
                document.getElementById('linkedinContent').innerHTML = linkedinText;
                
                // --- TIKTOK ---
                let tiktokRaw = pack.tiktok_script;
                let tiktokText = "No disponible";
                if (tiktokRaw) {
                    if (Array.isArray(tiktokRaw)) {
                        tiktokText = tiktokRaw.join('\n\n');
                    } else {
                        tiktokText = String(tiktokRaw);
                    }
                }
               // Truco visual mejorado: Colorear VISUAL, AUDIO, ESCENAS y NEGRILLAS DE ÉNFASIS
                tiktokText = tiktokText
                    // 1. Detectar escenas
                    .replace(/(?:\n|^)(?:\[?Escena\s+\d+\]?:?)/gi, function(match) {
                        return `<br><br><span class="text-yellow-500 font-bold border-b border-gray-600 w-full block mt-6 mb-2 uppercase">${match.replace(/[\[\]]/g, '')}</span>`;
                    })
                    // 2. Colorear VISUAL
                    .replace(/\[?VISUAL\]?:?/gi, '<span class="text-pink-400 font-bold block mt-4 mb-1"><i class="fas fa-eye mr-2"></i>VISUAL:</span>')
                    // 3. Colorear AUDIO
                    .replace(/\[?AUDIO\]?:?/gi, '<span class="text-green-400 font-bold block mt-2 mb-1"><i class="fas fa-microphone mr-2"></i>AUDIO:</span>')
                    
                    // --- NUEVO: Convertir **énfasis** en texto brillante/negrita ---
                    .replace(/\*\*(.*?)\*\*/g, '<span class="text-white font-extrabold border-b-2 border-purple-500/50">$1</span>');
                
                document.getElementById('tiktokContent').innerHTML = tiktokText;
                document.getElementById('viralSection').classList.remove('hidden');

            } else {
                document.getElementById('viralSection').classList.add('hidden');
            }

            document.getElementById('resultArea').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function procesarYoutube() {
            const url = document.getElementById('videoUrl').value;
            if(!url) return alert("Por favor, pega un enlace de YouTube.");
            
            const body = new URLSearchParams();
            body.append('url', url);
            
            apiCall('/transformar', body);
        }

        function procesarArchivo() {
            const file = fileInput.files[0];
            if(!file) return alert("Selecciona un archivo primero.");
            
            const formData = new FormData();
            formData.append('file', file);
            
            apiCall('/subir', formData);
        }

        function showUI(loading) {
            document.getElementById('loader').classList.toggle('hidden', !loading);
            document.getElementById('btnYoutube').disabled = loading;
            document.getElementById('btnFile').disabled = loading;
            if(loading) {
                document.getElementById('btnYoutube').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('btnYoutube').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function hideResults() {
            document.getElementById('resultArea').classList.add('hidden');
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                // Feedback visual simple
                const originalText = document.activeElement.innerText;
                alert("¡Contenido copiado al portapapeles!");
            });
        }
    </script>
</body>
</html>
